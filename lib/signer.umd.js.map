{"version":3,"file":"signer.umd.js","sources":["../src/signer.ts"],"sourcesContent":["import fetch from 'node-fetch'\nimport { TypedDataUtils, SignTypedDataVersion } from '@metamask/eth-sig-util'\nimport { Wallet } from '@ethersproject/wallet'\nimport {\n  arrayify,\n  concat,\n  splitSignature,\n  joinSignature,\n} from '@ethersproject/bytes'\nimport { createTxRaw } from '@tharsis/proto'\nimport {\n  createTxRawEIP712,\n  signatureToWeb3Extension,\n  Sender,\n  TxGenerated,\n  Chain,\n} from '@tharsis/transactions'\nimport { signatureToPubkey } from '@hanchon/signature-to-pubkey'\nimport { ethToEvmos } from '@tharsis/address-converter'\n\n// Chain helpers\n\nexport const LOCALNET_CHAIN = {\n  chainId: 9000,\n  cosmosChainId: 'evmos_9000-1',\n}\n\nexport const LOCALNET_FEE = {\n  amount: '20',\n  denom: 'aevmos',\n  gas: '200000',\n}\n\nexport const MAINNET_CHAIN = {\n  chainId: 9001,\n  cosmosChainId: 'evmos_9001-2',\n}\n\nexport const MAINNET_FEE = {\n  amount: '3000000000000000',\n  denom: 'aevmos',\n  gas: '150000',\n}\n\nexport const TESTNET_CHAIN = {\n  chainId: 9000,\n  cosmosChainId: 'evmos_9000-4',\n}\n\nexport const TESTNET_FEE = {\n  amount: '5000',\n  denom: 'atevmos',\n  gas: '600000',\n}\n\n// Get Account\n/* eslint-disable camelcase */\ninterface AccountResponse {\n  account: {\n    '@type': string\n    base_account: {\n      address: string\n      pub_key?: {\n        '@type': string\n        key: string\n      }\n      account_number: string\n      sequence: string\n    }\n    code_hash: string\n  }\n}\n\nexport async function generatePubkey(wallet: Wallet) {\n  // Sign the personal message `generate_pubkey` and generate the pubkey from that signature\n  const signature = await wallet.signMessage('generate_pubkey')\n  return signatureToPubkey(\n    signature,\n    Buffer.from([\n      50, 215, 18, 245, 169, 63, 252, 16, 225, 169, 71, 95, 254, 165, 146, 216,\n      40, 162, 115, 78, 147, 125, 80, 182, 25, 69, 136, 250, 65, 200, 94, 178,\n    ]),\n  )\n}\n\nexport async function getSender(\n  wallet: Wallet,\n  url: string = 'http://127.0.0.1:1317',\n) {\n  const evmosAddress = ethToEvmos(wallet.address)\n  const addrRequest = await fetch(\n    `${url}/cosmos/auth/v1beta1/accounts/${evmosAddress}`,\n  )\n  const resp = (await addrRequest.json()) as AccountResponse\n\n  const sender = {\n    accountAddress: evmosAddress,\n    sequence: parseInt(resp.account.base_account.sequence as string, 10),\n    accountNumber: parseInt(resp.account.base_account.account_number, 10),\n    pubkey:\n      resp.account.base_account.pub_key?.key || (await generatePubkey(wallet)),\n  }\n  return sender\n}\n\n// Broadcast a transaction in json.stringify format\nexport async function broadcast(\n  transactionBody: string,\n  url: string = 'http://127.0.0.1:1317',\n) {\n  const post = await fetch(`${url}/cosmos/tx/v1beta1/txs`, {\n    method: 'post',\n    body: transactionBody,\n    headers: { 'Content-Type': 'application/json' },\n  })\n  const data = await post.json()\n  return data\n}\n\n// Sign transaction using payload method (keplr style)\nexport async function signTransaction(\n  wallet: Wallet,\n  tx: TxGenerated,\n  broadcastMode: string = 'BROADCAST_MODE_BLOCK',\n) {\n  const dataToSign = `0x${Buffer.from(\n    tx.signDirect.signBytes,\n    'base64',\n  ).toString('hex')}`\n\n  /* eslint-disable no-underscore-dangle */\n  const signatureRaw = wallet._signingKey().signDigest(dataToSign)\n  const splitedSignature = splitSignature(signatureRaw)\n  const signature = arrayify(concat([splitedSignature.r, splitedSignature.s]))\n\n  const signedTx = createTxRaw(\n    tx.signDirect.body.serializeBinary(),\n    tx.signDirect.authInfo.serializeBinary(),\n    [signature],\n  )\n  const body = `{ \"tx_bytes\": [${signedTx.message\n    .serializeBinary()\n    .toString()}], \"mode\": \"${broadcastMode}\" }`\n\n  return body\n}\n\n// Sign transaction using eip712 method (metamask style)\nexport async function signTransactionUsingEIP712(\n  wallet: Wallet,\n  sender: string,\n  tx: TxGenerated,\n  chain: Chain = LOCALNET_CHAIN,\n  broadcastMode: string = 'BROADCAST_MODE_BLOCK',\n) {\n  const dataToSign = arrayify(\n    TypedDataUtils.eip712Hash(tx.eipToSign as any, SignTypedDataVersion.V4),\n  )\n  /* eslint-disable no-underscore-dangle */\n  const signatureRaw = wallet._signingKey().signDigest(dataToSign)\n  const signature = joinSignature(signatureRaw)\n\n  const extension = signatureToWeb3Extension(\n    chain,\n    { accountAddress: sender } as Sender,\n    signature,\n  )\n  const signedTx = createTxRawEIP712(\n    tx.legacyAmino.body,\n    tx.legacyAmino.authInfo,\n    extension,\n  )\n\n  return `{ \"tx_bytes\": [${signedTx.message\n    .serializeBinary()\n    .toString()}], \"mode\": \"${broadcastMode}\" }`\n}\n"],"names":["signTransactionUsingEIP712","generatePubkey","wallet","Promise","resolve","signMessage","then","signature","signatureToPubkey","Buffer","from","e","reject","LOCALNET_CHAIN","chainId","cosmosChainId","amount","denom","gas","transactionBody","url","fetch","method","body","headers","post","json","evmosAddress","ethToEvmos","address","addrRequest","resp","_resp$account$base_ac2","_temp","_generatePubkey","accountAddress","sequence","_parseInt","accountNumber","_parseInt2","pubkey","parseInt","account","base_account","account_number","_resp$account$base_ac","pub_key","key","tx","broadcastMode","dataToSign","signDirect","signBytes","toString","signatureRaw","_signingKey","signDigest","splitSignature","arrayify","concat","splitedSignature","r","s","createTxRaw","serializeBinary","authInfo","message","sender","chain","TypedDataUtils","eip712Hash","eipToSign","SignTypedDataVersion","V4","joinSignature","extension","signatureToWeb3Extension","createTxRawEIP712","legacyAmino","signedTx"],"mappings":"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"}